---
title: "Makeover Monday Visualizations"
output: github_document
knit: (function(input, ...) { rmarkdown::render(input, output_file = "README.md", envir = globalenv()) })
---

Sharing weekly visualizations from the [Makeover Monday](https://data.world/makeovermonday) series.

___

# Contents

- [Importing Required Packages]
- [2023 Week 14: Chicago Hate Crimes]
- [2023 Week 15: The DougScore]
- [Script Runtime]

Adding this as a test. Please ignore.

### Importing Required Packages

```{r include = F}
knitr::knit_hooks$set(source = function(x, options) {
    hook.r = function(x, options) {
      fence = "```"
      language = tolower(options$engine)
      if (language == "node") language = "javascript"
      if (!options$highlight) language = "text"
      if (!is.null(options$fold_code)) {
        paste0("\n\n", "<details><summary>View Code</summary>\n", fence, language, "\n", x, fence, "\n\n", "</details>\n")
      } else paste0('\n\n', fence, language, '\n', x, fence,  '\n\n')
    }
    x = knitr:::hilight_source(x, "markdown", options)
    hook.r(paste(c(x, ""), collapse = "\n"), options)
})
```

```{r message = F, warning = F}
tictoc::tic()

library(tidyverse)
library(tidymodels)
library(lubridate)
library(tvthemes)
library(janitor)
library(patchwork)
library(readxl)
library(vip)

theme_custom = theme_avatar() +
  theme(plot.title = element_text(hjust = 0.5),
        panel.grid.major = element_line(linewidth = 0.5, colour = "#D6D0C4"),
        panel.grid.minor = element_line(linewidth = 0.5, colour = "#D6D0C4"))

theme_set(theme_custom)
custom_olive = "#8C9F88"
```

### 2023 Week 14: Chicago Hate Crimes

*Data about hate crimes in Chicago from the Chicago Police Department*

```{r fold_code = T}
df = clean_names(read_excel("data/chicago_hate_crimes.xlsx"))

five_digit_dates = df |>
  filter(nchar(date) == 5) |>
  mutate(date = as.Date(as.numeric(date), origin = "1899-01-01"))

digits_21_dates = df |>
  filter(nchar(date) == 21) |>
  mutate(date = mdy(substr(date, 1, 9)))

digits_22_dates = df |>
  filter(nchar(date) == 22) |>
  mutate(date = mdy(substr(date, 1, 10)))

df2 = bind_rows(five_digit_dates, digits_21_dates, digits_22_dates)

df2 |>
  count(date) |>
  group_by(year(date)) |>
  mutate(cum_n = cumsum(n)) |>
  ungroup() |>
  mutate(date = as_date(paste0("2020-", substr(as.character(date), 6, 10))),
         `year(date)` = factor(`year(date)`)) |>
  rename(year = "year(date)") |>
  filter(year %in% 2017:2023) |>
  ggplot(aes(date, cum_n)) +
  geom_line(aes(col = year), linewidth = 2) +
  scale_x_date(date_labels = c("December", "January", "April", "July", "October")) +
  theme(legend.position = "right") +
  labs(x = NULL, y = "Cumulative Sum",
       title = "Cumulative Sum of Hate Crimes in Chicago, 2017-2023", col = "Year")
```

```{r include = F}
rm(df, df2, five_digit_dates, digits_21_dates, digits_22_dates)
```

___

### 2023 Week 15: The DougScore

*Which cars are the best cars ever driven by Doug Demuro?*

```{r fold_code = T}
df = clean_names(read_excel("data/doug_data.xlsx"))

makes_df = df |>
  count(make) |>
  filter(n >= 12) |>
  mutate(make_n = paste0(make, " (", n, ")"))

boxplots = df |>
  right_join(makes_df, by = "make") |>
  ggplot(aes(reorder(make_n, dougscore), dougscore)) +
  geom_boxplot(aes(fill = make_n), show.legend = F) +
  coord_flip() +
  scale_fill_manual(values = c("#002420", "#EB0D3F", "#1B5FAA", "#009ADA",
                               "#A87A25", "#972626", "#00A551", "#004377",
                               "#CC0000", "#F7DE9F", "#DFE1E0", "#FF8000",
                               "#565F64", "#B12B28", "#004489", "#F5313E")) +
  labs(x = NULL, y = "DougScore", title = "Boxplots of DougScores by Vehicle Make",
       subtitle = "Only Vehicles with 12+ Observations Included") +
  theme(plot.subtitle = element_text(hjust = 0.5, size = 9, face = "italic", vjust = 2))

df = df |>
  select(year, styling, acceleration, handling, fun_factor,
         cool_factor, features, comfort, quality, practicality, value, dougscore)

# cars_split = initial_split(df, strata = dougscore)
# cars_train = training(cars_split)
# cars_test = testing(cars_split)
cars_rec = recipe(dougscore ~ ., data = df)
# cars_prep = prep(cars_rec)
# juiced = juice(cars_prep)

# these hyperparameters were obtained from tuning
tune_spec = rand_forest(trees = 153, mtry = 7, min_n = 2) |>
  set_mode("regression") |>
  set_engine("ranger")

tune_wf = workflow() |>
  add_recipe(cars_rec) |>
  add_model(tune_spec)

# cars_folds = vfold_cv(cars_train, v = 5)
# doParallel::registerDoParallel()
# tune_res = tune_grid(tune_wf, resamples = cars_folds, grid = 25)
# best_rmse = select_best(tune_res, "rmse")
# final_rf = finalize_model(tune_spec, best_rmse)

vip_plot = tune_spec |>
  set_engine("ranger", importance = "permutation") |>
  fit(dougscore ~ ., data = df) |>
  vip(geom = "point") +
  labs(title = "Variable Importance for Predicting DougScore")

boxplots / vip_plot
```

```{r include = F}
rm(df, makes_df, cars_rec, tune_spec, tune_wf, boxplots, vip_plot)
```

___




















### Script Runtime

```{r echo = F}
tictoc::toc()
```








































